#!/bin/bash
set -euo pipefail

# Initialize the Trimorph package database
DB_FILE="/var/lib/trimorph/packages.db"
DB_DIR=$(dirname "$DB_FILE")

# Create database directory if it doesn't exist
sudo mkdir -p "$DB_DIR"
sudo chown "$(id -u):$(id -g)" "$DB_DIR" 2>/dev/null || true

# Create the database file with proper structure if it doesn't exist
if [[ ! -f "$DB_FILE" ]]; then
    sudo touch "$DB_FILE"
    sudo chown "$(id -u):$(id -g)" "$DB_FILE" 2>/dev/null || true
    
    # Initialize with JSON structure
    {
        echo "{"
        echo "  \"packages\": {}"
        echo "}"
    } | sudo tee "$DB_FILE" > /dev/null
    echo "Database initialized: $DB_FILE"
else
    echo "Database already exists: $DB_FILE"
fi

echo "Trimorph database ready."