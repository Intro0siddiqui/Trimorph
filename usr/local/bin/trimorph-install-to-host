#!/bin/bash
set -euo pipefail

# Check for required dependencies
check_dependencies() {
    local missing_deps=()
    
    # Check for required commands
    for cmd in sudo systemd-nspawn mktemp find; do
        if ! command -v "$cmd" &> /dev/null; then
            missing_deps+=("$cmd")
        fi
    done
    
    # Check for required trimorph scripts
    local script_dir=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
    for script in trimorph-db trimorph-validate trimorph-dry-run; do
        if [[ ! -x "$script_dir/$script" ]]; then
            missing_deps+=("$script_dir/$script")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo "Error: Missing required dependencies:"
        for dep in "${missing_deps[@]}"; do
            echo "  - $dep"
        done
        exit 1
    fi
}

check_dependencies

# --- Self-locating Script ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)

# Allow overriding paths for testing, with sensible defaults
TRIMORPH_ETC_DIR="${TRIMORPH_ETC_DIR:-/etc/trimorph}"
TRIMORPH_BASE_DIR="${TRIMORPH_BASE_DIR:-/usr/local/trimorph/base}"
TRIMORPH_CACHE_DIR="${TRIMORPH_CACHE_DIR:-/var/cache/trimorph/packages}"

# Check required arguments
if [[ $# -lt 2 ]]; then
    echo "Usage: $0 <jail> <package> [package...]"
    exit 1
fi

jail="$1"; shift

# Ensure configuration directory exists
config_dir="${TRIMORPH_ETC_DIR}/jails.d"
if [[ ! -d "$config_dir" ]]; then
    echo "Error: Configuration directory does not exist: $config_dir"
    echo "Please create the directory and add jail configuration files"
    exit 1
fi

conf="${TRIMORPH_ETC_DIR}/jails.d/$jail.conf"
if [[ ! -r "$conf" ]]; then
    echo "[FAIL] Config file not found or not readable: $conf"
    exit 1
fi

# Source configuration
source <($SCRIPT_DIR/../sbin/trimorph-parse-conf "$conf")

echo "Installing packages to host from jail: $jail"
echo "Packages: $*"

# Validate packages exist before installation
for package in "$@"; do
    if ! "$SCRIPT_DIR/../sbin/trimorph-validate" "$jail" "$package" >/dev/null 2>&1; then
        echo "Error: Package '$package' not found in jail '$jail'"
        exit 1
    fi
done

# Run dry run to preview what would be installed
echo
echo "Preview of files to be installed:"
"$SCRIPT_DIR/trimorph-dry-run" "$jail" "$@"

# Confirm installation
echo
read -p "Do you want to proceed with installation? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Installation cancelled."
    exit 0
fi

# Use the main install script to do the actual installation
exec "$SCRIPT_DIR/../sbin/trimorph-install" "$jail" "$@"