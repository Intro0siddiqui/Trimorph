#!/bin/bash
set -euo pipefail

# Check for available updates to installed foreign packages

DB_FILE="/var/lib/trimorph/packages.db"

if [[ ! -f "$DB_FILE" ]]; then
    echo "No packages installed via Trimorph, or database not found."
    exit 0
fi

echo "Checking for updates to Trimorph-installed packages..."

# Read database and check for updates
if command -v jq &> /dev/null; then
    # Use jq if available to parse the database
    package_count=$(jq -r '.packages | length' "$DB_FILE")
    if [[ "$package_count" -gt 0 ]]; then
        echo "Found $package_count Trimorph-installed packages:"
        jq -r '.packages | to_entries[] | "\(.key) (\(.value.version)) from jail \(.value.jail))"' "$DB_FILE"
        echo
        echo "Update checking is not yet implemented in this version of Trimorph."
        echo "You can manually check for updates by running:"
        echo "  trimorph-validate <jail> <package>"
    else
        echo "No packages installed via Trimorph."
    fi
else
    echo "jq is required to read the package database. Please install jq to check for updates."
    exit 1
fi