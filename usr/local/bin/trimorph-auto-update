#!/bin/bash
set -euo pipefail

# Automatic update management for Trimorph-installed packages

# Configuration settings for auto-updates
CONFIG_FILE="/etc/trimorph/trimorph.conf"

# Default settings
AUTO_UPDATE_DEFAULT="false"
CHECK_UPDATES_DEFAULT="true"
UPDATE_SECURITY_ONLY_DEFAULT="false"

# Load configuration if it exists
AUTO_UPDATE="$AUTO_UPDATE_DEFAULT"
CHECK_UPDATES="$CHECK_UPDATES_DEFAULT" 
UPDATE_SECURITY_ONLY="$UPDATE_SECURITY_ONLY_DEFAULT"

if [[ -f "$CONFIG_FILE" ]]; then
    # Source configuration file if it exists
    # Format: SETTING=value
    while IFS='=' read -r key value; do
        case "$key" in
            auto_update) AUTO_UPDATE="$value" ;;
            check_updates) CHECK_UPDATES="$value" ;;
            update_security_only) UPDATE_SECURITY_ONLY="$value" ;;
        esac
    done < <(grep -E "^(auto_update|check_updates|update_security_only)=" "$CONFIG_FILE" 2>/dev/null || true)
fi

# Check if auto-updates are enabled
if [[ "$AUTO_UPDATE" != "true" ]]; then
    echo "Auto-updates are disabled (auto_update=$AUTO_UPDATE in $CONFIG_FILE)"
    exit 0
fi

# Check if update checking is enabled
if [[ "$CHECK_UPDATES" != "true" ]]; then
    echo "Update checking is disabled (check_updates=$CHECK_UPDATES in $CONFIG_FILE)"
    exit 0
fi

echo "Running auto-update check..."

# Run the update check
/usr/local/bin/trimorph-update-check

echo "Auto-update check completed."